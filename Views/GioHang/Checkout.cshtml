@model WebPetShop.ViewModels.CheckoutVM
@{
    ViewData["Title"] = "Thanh toán đơn hàng";
}

<div class="container py-5">
    <!-- 🔹 Header -->
    <div class="text-center mb-5">
        <h2 class="fw-bold text-danger">
            <i class="fa-solid fa-credit-card me-2"></i> Thanh toán đơn hàng
        </h2>
        <p class="text-muted mb-0">Hoàn tất thông tin giao hàng và chọn phương thức thanh toán 💳</p>
    </div>

    <div class="row g-4">
        <!-- 🔸 CỘT TRÁI: THÔNG TIN GIAO HÀNG -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-danger text-white fw-semibold">
                    <i class="fa-solid fa-truck-fast me-2"></i> Thông tin giao hàng
                </div>
                <div class="card-body">
                    <!-- ✅ FIX QUAN TRỌNG: thêm asp-controller="GioHang" để gửi đúng -->
                    <form asp-action="XacNhan" asp-controller="GioHang" method="post">
                        @Html.AntiForgeryToken()

                        <!-- Họ tên + SĐT -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Họ tên người nhận</label>
                                <input asp-for="HoTenNhan" class="form-control" placeholder="Nhập họ tên người nhận" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Số điện thoại</label>
                                <input asp-for="SDTNhan" class="form-control" placeholder="Nhập số điện thoại" required />
                            </div>
                        </div>

                        <!-- Địa chỉ -->
                        <div class="mt-3">
                            <label class="form-label fw-semibold">Địa chỉ giao hàng</label>
                            <textarea asp-for="DiaChiGiao" class="form-control" rows="2" placeholder="Nhập địa chỉ nhận hàng" required></textarea>
                        </div>

                        <!-- Khu vực giao hàng -->
                        <div class="mt-3">
                            <label class="form-label fw-semibold">Khu vực giao hàng</label>
                            <select id="selectPhiGiaoHang" asp-for="MaPhi" class="form-select" required>
                                <option value="">-- Chọn khu vực giao hàng --</option>
                                @foreach (var phi in Model.PhiGiaoHangList ?? Enumerable.Empty<WebPetShop.Models.PhiGiaoHang>())
                                {
                                    <option value="@phi.MaPhi" data-phi="@phi.PhiCoDinh">
                                        @phi.KhuVuc - @phi.DonViGiao (@(phi.PhiCoDinh?.ToString("N0") ?? "0") đ)
                                    </option>
                                }
                            </select>
                        </div>

                        <!-- Mã khuyến mãi -->
                        <div class="mt-3">
                            <label class="form-label fw-semibold">Mã khuyến mãi</label>
                            <div class="input-group">
                                <input asp-for="MaCode" class="form-control" placeholder="Nhập mã giảm giá (nếu có)" />
                                <button type="button" id="btnApplyCode" class="btn btn-outline-danger">Áp dụng</button>
                            </div>
                            <div id="discountInfo" class="small text-success mt-1"></div>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="mt-4">
                            <label class="form-label fw-semibold">Phương thức thanh toán</label>
                            <div class="border rounded p-3 bg-light">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" asp-for="PhuongThuc" value="COD" checked />
                                    <label class="form-check-label">💵 Thanh toán khi nhận hàng (COD)</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" asp-for="PhuongThuc" value="Bank" />
                                    <label class="form-check-label">🏦 Chuyển khoản ngân hàng</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" asp-for="PhuongThuc" value="Online" />
                                    <label class="form-check-label">💳 Thanh toán Online (VNPay, MoMo, ZaloPay)</label>
                                </div>
                            </div>
                        </div>

                        <!-- Nút -->
                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Index" asp-controller="GioHang" class="btn btn-outline-secondary">
                                <i class="fa-solid fa-arrow-left"></i> Quay lại giỏ hàng
                            </a>
                            <button type="submit" class="btn btn-danger fw-bold px-4">
                                <i class="fa-solid fa-check-circle"></i> Xác nhận đặt hàng
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 🔸 CỘT PHẢI: TÓM TẮT ĐƠN HÀNG -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-danger text-white fw-semibold">
                    <i class="fa-solid fa-box-open me-2"></i> Đơn hàng của bạn
                </div>
                <div class="card-body">
                    @foreach (var item in Model.GioHang)
                    {
                        <div class="d-flex align-items-center mb-3 border-bottom pb-2">
                            <img src="~/images/@item.MaSpNavigation.HinhAnh" width="60" height="60" class="rounded me-3" />
                            <div class="flex-grow-1">
                                <div class="fw-semibold">@item.MaSpNavigation.TenSp</div>
                                <small class="text-muted">Số lượng: @item.SoLuong</small>
                            </div>
                            <div class="text-danger fw-semibold">@item.MaSpNavigation.Gia.ToString("N0") đ</div>
                        </div>
                    }

                    <!-- Tổng kết -->
                    <div class="d-flex justify-content-between mt-3">
                        <span>Tạm tính:</span>
                        <span id="tienHang">@Model.TienHang.ToString("N0") đ</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Giảm giá:</span>
                        <span id="giamGia">@Model.GiamGia.ToString("N0") đ</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Phí giao hàng:</span>
                        <span id="phiShip">@Model.PhiVanChuyen.ToString("N0") đ</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>Tổng cộng:</span>
                        <span class="text-danger" id="tongTien">@Model.TongTien.ToString("N0") đ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const selectPhi = document.getElementById('selectPhiGiaoHang');
        const tienHang = parseFloat('@Model.TienHang');
        const giamGia = parseFloat('@Model.GiamGia');
        const phiSpan = document.getElementById('phiShip');
        const tongSpan = document.getElementById('tongTien');

        selectPhi?.addEventListener('change', () => {
            const phi = parseFloat(selectPhi.options[selectPhi.selectedIndex]?.dataset.phi || 0);
            phiSpan.innerText = phi.toLocaleString('vi-VN') + ' đ';
            const tong = tienHang - giamGia + phi;
            tongSpan.innerText = tong.toLocaleString('vi-VN') + ' đ';
        });

        // Demo áp dụng mã giảm giá (client-side)
        const btnApply = document.getElementById('btnApplyCode');
        btnApply?.addEventListener('click', () => {
            const discountInfo = document.getElementById('discountInfo');
            const code = document.querySelector('[name="MaCode"]').value.trim();
            if (code === 'PETSHOP10') {
                discountInfo.innerText = '🎉 Mã giảm giá 10% đã áp dụng!';
                document.getElementById('giamGia').innerText = (tienHang * 0.1).toLocaleString('vi-VN') + ' đ';
                tongSpan.innerText = (tienHang * 0.9).toLocaleString('vi-VN') + ' đ';
            } else {
                discountInfo.innerText = '❌ Mã không hợp lệ hoặc hết hạn!';
            }
        });
    </script>
}
