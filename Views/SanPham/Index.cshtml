@model IEnumerable<WebPetShop.Models.SanPham>
@using System.Globalization

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Sản phẩm";
    var kmList = ViewBag.KhuyenMai as List<WebPetShop.Models.KhuyenMai>;
}

@if (Model == null || !Model.Any())
{
    <p class="text-center text-danger fw-bold">🐾 Không có sản phẩm nào!</p>
}
else
{
    <div class="row g-4">
        @foreach (var item in Model)
        {
            // Lấy thông tin khuyến mãi cho sản phẩm hiện tại
            var km = kmList?.FirstOrDefault(x => x.MaSP == item.MaSp);
            var giaSauGiam = km != null ? item.Gia - (item.Gia * km.PhanTramGiam / 100) : item.Gia;

            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                <div class="card product-card shadow-sm text-center">

                    <!-- 🖼️ Ảnh sản phẩm -->
                    <img src="/ImagesWWeb/@item.HinhAnh"
                         class="card-img-top"
                         alt="@item.TenSp"
                         style="height:180px; object-fit:cover; border-radius:10px" />

                    <!-- 💬 Thông tin sản phẩm -->
                    <div class="card-body px-2">

                        <!-- Tên SP -->
                        <p class="fw-semibold text-dark text-truncate mb-1">@item.TenSp</p>

                        <!-- ⭐ HIỂN THỊ ĐÁNH GIÁ -->
                        @{
                            var soDanhGia = item.DanhGia?.Count() ?? 0;
                            double diemTrungBinh = soDanhGia > 0
                                ? item.DanhGia.Average(d => d.Diem) ?? 0
                                : 0;
                        }

                        @if (soDanhGia > 0)
                        {
                            <div class="mb-1">
                                <span class="text-warning fw-bold">
                                    @for (int i = 0; i < Math.Round(diemTrungBinh); i++)
                                    {
                                        <i class="fa-solid fa-star"></i>
                                    }
                                </span>

                                <span class="text-muted" style="font-size:13px;">
                                    (@soDanhGia đánh giá)
                                </span>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted" style="font-size:13px;">Chưa có đánh giá</p>
                        }

                        <!-- Giá -->
                        <p class="text-danger fw-bold mb-2">
                            @String.Format("{0:N0} đ", giaSauGiam)
                            @if (km != null)
                            {
                                <span class="text-decoration-line-through text-secondary fs-6">
                                    @String.Format("{0:N0} đ", item.Gia)
                                </span>
                            }
                        </p>

                        <!-- 🛍️ Nút Mua ngay -->
                        <button class="btn btn-sm btn-danger rounded-pill px-3 fw-semibold shadow-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#buyNowModal"
                                data-id="@item.MaSp"
                                data-name="@item.TenSp"
                                data-price="@giaSauGiam"
                                data-image="/ImagesWWeb/@item.HinhAnh">
                            🛍️ Mua ngay
                        </button>

                    </div>
                </div>
            </div>
        }
    </div>
}

<!-- 🧾 MODAL CHI TIẾT MUA HÀNG -->
<div class="modal fade" id="buyNowModal" tabindex="-1" aria-labelledby="buyNowModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold" id="buyNowModalLabel">🛍️ Thông tin sản phẩm</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="d-flex align-items-center">
                    <img id="modalImage" src="" alt="Ảnh sản phẩm"
                         class="rounded-3 me-3"
                         style="width: 120px; height: 120px; object-fit: cover;">
                    <div>
                        <h6 id="modalName" class="fw-bold mb-2"></h6>
                        <p id="modalPrice" class="text-danger fw-semibold mb-2"></p>

                        <div class="d-flex align-items-center">
                            <label for="quantity" class="me-2 fw-semibold">Số lượng:</label>
                            <input type="number" id="modalQuantity" class="form-control form-control-sm w-25" min="1" value="1">
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <a id="btnAddToCart" href="#" class="btn btn-outline-danger rounded-pill fw-semibold">
                    🛒 Thêm vào giỏ hàng
                </a>
                <a id="btnBuyNow" href="#" class="btn btn-danger rounded-pill fw-semibold">
                    💳 Mua ngay
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 💅 CSS -->
<style>
    .product-card {
        border-radius: 16px;
        padding: 10px;
        background: #FDFDFE;
        transition: all 0.3s ease;
    }

    .product-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 18px rgba(217, 54, 54, 0.2);
    }

    .product-card img {
        transition: transform 0.4s ease;
    }

    .product-card:hover img {
        transform: scale(1.05);
    }

    .btn-danger {
        background-color: #D93636;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-danger:hover {
        background-color: #c22f2f;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(217, 54, 54, 0.3);
    }

    #buyNowModal .modal-content {
        border-radius: 20px;
        overflow: hidden;
    }

    body {
        padding-top: 140px;
    }
</style>

<!-- ⚙️ SCRIPT XỬ LÝ MODAL -->
<script>
    const buyNowModal = document.getElementById('buyNowModal');
    buyNowModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        const price = Number(button.getAttribute('data-price')); // convert sang number
        const image = button.getAttribute('data-image');

        document.getElementById('modalName').textContent = name;
        document.getElementById('modalPrice').textContent = new Intl.NumberFormat().format(price) + ' đ';
        document.getElementById('modalImage').src = image;

        const quantityInput = document.getElementById('modalQuantity');
        const btnAddToCart = document.getElementById('btnAddToCart');
        const btnBuyNow = document.getElementById('btnBuyNow');

        const updateLinks = () => {
            const qty = quantityInput.value || 1;
            // truyền giá khuyến mãi trong query string nếu cần
            btnAddToCart.href = `/GioHang/Them/${id}?soLuong=${qty}&gia=${price}`;
            btnBuyNow.href = `/GioHang/MuaNgay/${id}?soLuong=${qty}&gia=${price}`;
        };

        updateLinks();
        quantityInput.addEventListener('input', updateLinks);
    });
</script>
