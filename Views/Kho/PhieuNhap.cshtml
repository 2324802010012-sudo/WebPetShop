@model IEnumerable<WebPetShop.Models.PhieuNhap>
@{
    ViewData["Title"] = "Quản lý phiếu nhập";
    Layout = "~/Views/Kho/_LayoutKho.cshtml";

    // ✅ Dữ liệu thống kê tháng hiện tại
    var tongThang = Model
        .Where(p => p.NgayNhap?.Month == DateTime.Now.Month && p.NgayNhap?.Year == DateTime.Now.Year)
        .Sum(p => p.TongTien ?? 0);

    var tongPhieuThang = Model
        .Count(p => p.NgayNhap?.Month == DateTime.Now.Month && p.NgayNhap?.Year == DateTime.Now.Year);

    // ✅ Chuẩn bị dữ liệu biểu đồ 12 tháng gần nhất
    var dataChart = Enumerable.Range(1, 12)
        .Select(m => new
        {
            Thang = m,
            Tong = Model
                .Where(p => p.NgayNhap.HasValue &&
                            p.NgayNhap.Value.Month == m &&
                            p.NgayNhap.Value.Year == DateTime.Now.Year)
                .Sum(p => p.TongTien ?? 0)
        }).ToList();
}

<div class="container-fluid py-4">

    <!-- 📊 BIỂU ĐỒ THỐNG KÊ NHẬP HÀNG -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-danger text-white fw-bold">
            <i class="fa-solid fa-chart-line me-2"></i>Thống kê tổng giá trị nhập hàng theo tháng (@DateTime.Now.Year)
        </div>
        <div class="card-body">
            <canvas id="chartNhapHang" height="100"></canvas>
        </div>
    </div>

    <!-- 🧭 DASHBOARD MINI -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 text-white h-100" style="background: linear-gradient(135deg,#ff4d4d,#b30000);">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="fw-semibold text-white-50 mb-1">Tổng phiếu nhập tháng này</h6>
                        <h3 class="fw-bold">@tongPhieuThang</h3>
                    </div>
                    <i class="fa-solid fa-file-import fa-2x opacity-75"></i>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 text-white h-100" style="background: linear-gradient(135deg,#ff6666,#c0392b);">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="fw-semibold text-white-50 mb-1">Tổng giá trị nhập tháng này</h6>
                        <h3 class="fw-bold">@tongThang.ToString("N0") ₫</h3>
                    </div>
                    <i class="fa-solid fa-money-bill-wave fa-2x opacity-75"></i>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 text-white h-100" style="background: linear-gradient(135deg,#ff8080,#e74c3c);">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="fw-semibold text-white-50 mb-1">Thời gian</h6>
                        <h3 class="fw-bold">@DateTime.Now.ToString("MM/yyyy")</h3>
                    </div>
                    <i class="fa-solid fa-calendar-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 🌟 TIÊU ĐỀ + TÌM KIẾM -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-danger mb-1">
                <i class="fa-solid fa-boxes-packing me-2"></i>Danh sách phiếu nhập
            </h3>
            <p class="text-muted mb-0">Tổng số: <span class="fw-bold text-dark">@Model.Count()</span> phiếu</p>
        </div>

        <div class="d-flex align-items-center gap-2">
            <input type="text" id="searchBox" class="form-control" placeholder="🔍 Tìm theo nhà cung cấp..." style="width: 260px;" />
            <a href="/Kho/ThemPhieuNhap" class="btn btn-danger shadow-sm px-4">
                <i class="fa fa-plus-circle me-2"></i>Thêm phiếu nhập
            </a>
        </div>
    </div>

    <!-- 🧾 DANH SÁCH PHIẾU NHẬP -->
    <div class="row g-4" id="listPhieu">
        @if (!Model.Any())
        {
            <div class="text-center py-5 text-muted">
                <i class="fa-solid fa-box-open fa-3x mb-3"></i>
                <div>Chưa có phiếu nhập nào trong hệ thống</div>
            </div>
        }
        else
        {
            foreach (var p in Model.OrderByDescending(p => p.NgayNhap))
            {
                <div class="col-md-6 col-lg-4 phieu-card" data-ncc="@p.MaNccNavigation?.TenNcc?.ToLower()">
                    <div class="card shadow-sm border-0 h-100 hover-shadow" style="border-top:4px solid #dc3545;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="fw-bold text-danger mb-0">
                                    <i class="fa-solid fa-file-lines me-2"></i>PN-@p.MaPn
                                </h5>
                                <span class="badge bg-danger-subtle text-danger border border-danger">Phiếu nhập</span>
                            </div>

                            <div class="text-muted small">
                                <div class="mb-1"><i class="fa-solid fa-industry me-1"></i> <strong>Nhà cung cấp:</strong> @p.MaNccNavigation?.TenNcc</div>
                                <div class="mb-1"><i class="fa-solid fa-user-tie me-1"></i> <strong>Nhân viên:</strong> @p.MaNhanVienNavigation?.HoTen</div>
                                <div class="mb-1"><i class="fa-regular fa-clock me-1"></i> <strong>Ngày nhập:</strong> @p.NgayNhap?.ToString("dd/MM/yyyy HH:mm")</div>
                                <div>
                                    <i class="fa-solid fa-money-bill-wave me-1"></i> <strong>Tổng tiền:</strong>
                                    <span class="fw-bold text-danger">@p.TongTien?.ToString("N0") ₫</span>
                                </div>
                            </div>
                        </div>

                        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                            <small class="text-muted">Cập nhật: @DateTime.Now.ToString("HH:mm dd/MM")</small>
                            <a href="/Kho/ChiTietPhieuNhap/@p.MaPn" class="btn btn-outline-danger btn-sm">
                                <i class="fa fa-eye me-1"></i>Xem
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- 💅 STYLE + SCRIPT -->
<style>
    .hover-shadow:hover {
        transform: translateY(-3px);
        transition: all 0.3s ease;
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    .bg-danger-subtle {
        background-color: #fbecec !important;
    }

    input#searchBox:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== BIỂU ĐỒ NHẬP HÀNG =====
        const ctx = document.getElementById("chartNhapHang").getContext("2d");
        const data = {
            labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(dataChart.Select(x => "T" + x.Thang))),
            datasets: [{
                label: "Tổng giá trị nhập (VNĐ)",
                data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(dataChart.Select(x => x.Tong))),
                borderColor: "#dc3545",
                backgroundColor: "rgba(220,53,69,0.2)",
                fill: true,
                tension: 0.3,
                pointRadius: 5,
                pointHoverRadius: 7,
                borderWidth: 2
            }]
        };
        new Chart(ctx, {
            type: "line",
            data: data,
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: "top" },
                    tooltip: { callbacks: { label: ctx => ctx.formattedValue.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ₫" } }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString("vi-VN") + " ₫" } }
                }
            }
        });

        // ===== TÌM KIẾM NHÀ CUNG CẤP =====
        document.getElementById("searchBox").addEventListener("keyup", function () {
            const keyword = this.value.toLowerCase().trim();
            document.querySelectorAll(".phieu-card").forEach(card => {
                const match = card.dataset.ncc.includes(keyword);
                card.style.display = match ? "block" : "none";
            });
        });
    </script>
}
